# 香港 IPO 打新计算器 - 产品需求文档 (PRD)

**文档版本**: v1.0  
**最后更新**: 2025-11-02  
**产品负责人**: Daiyu Xin  
**开发状态**: ✅ 已完成核心功能

---

## 📋 目录

1. [产品概述](#产品概述)
2. [用户画像](#用户画像)
3. [核心功能](#核心功能)
4. [功能详细说明](#功能详细说明)
5. [技术架构](#技术架构)
6. [数据模型](#数据模型)
7. [用户流程](#用户流程)
8. [UI/UX 设计原则](#uiux-设计原则)
9. [版本规划](#版本规划)
10. [附录](#附录)

---

## 产品概述

### 1.1 产品定位

香港 IPO 打新计算器是一款专为香港股市新股申购投资者设计的智能决策工具，帮助用户在申购前预测收益、在配售后验证策略，通过数据驱动的方式优化打新投资决策。

### 1.2 核心价值

- **事前预测**: 多方案组合对比，找出最优打新策略
- **事后验证**: 验证实际策略是否正确，分析改进空间
- **数据透明**: 自动读取数据库中的 IPO 数据，减少手动输入
- **融资优化**: 智能计算融资成本，帮助用户最大化收益率

### 1.3 使用场景

| 场景 | 描述 | 对应功能 |
|------|------|----------|
| **打新前决策** | 投资者有多个 IPO 可选，不确定如何分配资金 | 事前预测计算器 |
| **策略对比** | 想知道"全部打A" vs "分散打A+B"哪个更优 | 多方案对比 |
| **融资规划** | 评估不同融资倍数下的成本和收益 | 融资倍数选择 |
| **事后复盘** | 配售结果出来后，验证自己的策略是否正确 | 事后验证计算器 |
| **档位研究** | 查看某只新股的所有申购档位和配售比例 | 档位详情页 |

---

## 用户画像

### 2.1 主要用户群体

#### 👔 专业打新投资者
- **特征**: 全职或兼职打新，资金量 50万 - 500万 HKD
- **需求**: 精确计算、多方案对比、融资成本优化
- **痛点**: 手动计算繁琐，难以快速对比多个组合方案
- **使用频率**: 每周 3-5 次（每次有新股上市时）

#### 📊 量化投资者
- **特征**: 使用数据驱动决策，关注期望收益和风险
- **需求**: 历史数据查询、配售比例分析、数学期望计算
- **痛点**: 缺乏结构化的 IPO 数据和分析工具
- **使用频率**: 每天查看，构建打新模型

#### 🔰 散户投资者
- **特征**: 偶尔参与打新，资金量 5万 - 30万 HKD
- **需求**: 简单易用的收益计算，了解自己能赚多少
- **痛点**: 不懂复杂的计算公式，容易遗漏费用
- **使用频率**: 有兴趣的新股上市时使用

---

## 核心功能

### 3.1 功能模块架构

```
香港 IPO 打新计算器
│
├── 📊 新股列表与查询
│   ├── 展示所有招股书数据
│   ├── 按申购截止日期排序
│   └── 快速查看关键信息（代码、名称、发行价、日期等）
│
├── 💰 事前预测计算器（收益估算）
│   ├── 基础配置
│   │   ├── 本金输入
│   │   ├── 融资开关
│   │   ├── 融资倍数选择（5x/10x/15x/20x）
│   │   ├── 融资年利率
│   │   └── 持有天数
│   ├── 多方案管理
│   │   ├── 创建方案（A/B/C...）
│   │   ├── 删除方案
│   │   └── 切换编辑方案
│   ├── IPO 组合配置
│   │   ├── 添加/删除 IPO
│   │   ├── 选择 IPO 代码（自动填充发行价）
│   │   ├── 申购股数
│   │   ├── 预估中签率
│   │   ├── 预估中签股数
│   │   └── 预期涨幅
│   └── 计算与对比
│       ├── 期望收益计算
│       ├── 融资成本计算
│       ├── 净收益和收益率
│       ├── 方案对比表格
│       ├── 最优方案标记
│       └── 详细分析结论
│
├── ✅ 事后验证计算器（收益验证）
│   ├── 基础配置
│   │   ├── IPO 选择（手动输入+下拉建议）
│   │   ├── 发行价（自动填充）
│   │   ├── 申购股数
│   │   ├── 中签股数
│   │   ├── 卖出价格
│   │   └── 卖出费用
│   ├── 融资配置
│   │   ├── 融资金额
│   │   ├── 融资年利率
│   │   └── 持有天数
│   ├── 计算结果
│   │   ├── 实际收益
│   │   ├── 融资成本
│   │   ├── 净收益
│   │   ├── 收益率
│   │   └── 打和点
│   └── 策略对比（基于实际配售数据）
│       ├── 自动识别实际档位
│       ├── 计算所有档位的假设收益
│       ├── 对比表格（本金、融资额、收益等）
│       ├── 标记实际策略
│       ├── 建议最优策略
│       └── 数学期望分析
│
└── 📈 档位详情页
    ├── 股票基本信息
    ├── 申购明细表
    │   ├── 申请股数
    │   ├── 应缴费用
    │   ├── 组别
    │   ├── 有效申购人数
    │   ├── 中签人数
    │   └── 配发比例
    └── 刷新按钮（手动更新配售数据）
```

---

## 功能详细说明

### 4.1 新股列表与查询

#### 功能描述
展示数据库中所有的新股招股书信息，作为整个应用的入口页面。

#### 字段说明
| 字段 | 说明 | 数据来源 |
|------|------|----------|
| 代码 | 股票代码（4位数字） | 招股书表 |
| 公司名称 | 上市公司全称 | 招股书表 |
| 招股定价上限 | 发行价格上限 | 招股书表 |
| 申购截止日期 | 最后申购日期 | 招股书表 |
| 上市日期 | 预计上市日期 | 招股书表 |
| 操作 | "查看详情"按钮 | - |

#### 交互说明
- 默认按申购截止日期**降序**排列（最新的在前）
- 点击"查看详情"按钮，跳转到档位详情页
- 表格支持响应式布局，移动端自适应

#### 技术实现
```javascript
// API: GET /api/stocks
// 返回: Array<Stock>
{
  "代码": "2670",
  "公司名称": "赛力斯集团股份有限公司",
  "招股定价上限": 25.00,
  "申购截止日期": "2025-10-15",
  "上市日期": "2025-10-22"
  // ... 其他字段
}
```

---

### 4.2 事前预测计算器（收益估算）

#### 4.2.1 功能目标
帮助用户在申购前对比**多个打新方案**，通过预估中签率和涨幅，计算期望收益，找出最优组合策略。

#### 4.2.2 核心概念

**方案 (Plan)**  
一个独立的打新组合配置，包含一个或多个 IPO。例如：
- 方案A: 全部资金打赛力斯（40,000股）
- 方案B: 30,000股赛力斯 + 35,000股旺山旺水

**融资倍数**  
用户本金通过券商融资放大的倍数。例如本金10万，10倍融资后总资金100万。

**期望收益**  
考虑中签概率后的预期收益：  
`期望收益 = 预估中签股数 × 发行价 × 预期涨幅 × 预估中签率`

#### 4.2.3 输入参数

##### A. 基础配置

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| 本金 (HKD) | Number | ✅ | - | 用户自有资金 |
| 使用融资 | Boolean | ✅ | false | 是否启用融资 |
| 融资倍数 | Select | - | 10 | 5x/10x/15x/20x |
| 融资年利率 (%) | Number | - | 5 | 融资年化利率 |
| 持有天数 | Number | - | 7 | 从申购到卖出的天数 |

**总可用资金计算**:
```
总可用资金 = 本金 × 融资倍数（如未启用融资，则 = 本金）
```

##### B. 方案配置

每个方案可以配置多个 IPO，每个 IPO 需要填写：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| IPO代码 | String | ✅ | 4位股票代码，选择后自动填充名称和发行价 |
| 公司名称 | String | ✅ | 自动填充 |
| 申购股数 | Number | ✅ | 计划申购的股数 |
| 发行价 (HKD) | Number | ✅ | 自动填充，可手动修改 |
| 预估中签率 (%) | Number | ✅ | 基于历史数据或经验预估 |
| 预估中签股数 | Number | ✅ | 假设中签后能获得的股数 |
| 预期涨幅 (%) | Number | ✅ | 预计首日涨幅 |

#### 4.2.4 计算逻辑

##### 单个 IPO 的期望收益
```javascript
const capitalUsed = 申购股数 × 发行价
const expectedProfit = 预估中签股数 × 发行价 × (预期涨幅 / 100) × (预估中签率 / 100)
```

##### 方案总投入
```javascript
const totalCapitalUsed = Σ(每个IPO的capitalUsed)
```

##### 融资金额和融资成本
```javascript
if (使用融资 && totalCapitalUsed > 本金) {
  融资金额 = min(totalCapitalUsed - 本金, totalCapitalUsed × 0.9)
  融资成本 = 融资金额 × (融资年利率 / 100) × (持有天数 / 365)
} else {
  融资金额 = 0
  融资成本 = 0
}
```

##### 净收益和收益率
```javascript
const totalExpectedProfit = Σ(每个IPO的expectedProfit)
const 净收益 = totalExpectedProfit - 融资成本
const 收益率 = (净收益 / 本金) × 100
```

##### 方案有效性验证
```javascript
isValid = totalCapitalUsed <= 总可用资金 && totalCapitalUsed > 0
```

#### 4.2.5 输出结果

##### A. 方案对比表格

| 方案 | 总投入 (HKD) | 融资金额 (HKD) | 融资成本 (HKD) | 期望收益 (HKD) | 净收益 (HKD) | 收益率 (%) |
|------|--------------|----------------|----------------|----------------|--------------|------------|
| ✓ 方案A ⭐ | 1,000,000 | 900,000 | -630 | 12,500 | +11,870 | +11.87% |
| 方案B | 1,000,000 | 900,000 | -630 | 10,312 | +9,682 | +9.68% |

- **绿色高亮**: 最优方案（收益率最高）
- **⭐ 标记**: 最优方案

##### B. 分析结论

系统自动生成文字分析：
```
• 方案A 為最優方案，預期淨收益 HKD 11,870，收益率 11.87%
• 相比 方案B，方案A 多賺 HKD 2,188 (+22.6%)
• 本金：HKD 100,000，融資倍數：10倍
```

##### C. 计算说明

详细的计算公式说明：
```
• 期望收益 = 預估中籤股數 × 發行價 × 預期漲幅 × 預估中籤率
• 融資成本 = 融資金額 × (年利率 / 365) × 持有天數
• 淨收益 = 期望收益 - 融資成本
• 收益率 = 淨收益 / 本金 × 100%
• 以上計算僅供參考，實際收益會受市場波動、中籤率等多種因素影響
```

#### 4.2.6 边界情况处理

| 情况 | 错误提示 | 处理方式 |
|------|----------|----------|
| 未输入本金 | "請輸入有效的本金金額" | 阻止计算 |
| 未添加 IPO | "請至少為一個方案添加IPO配置" | 阻止计算 |
| 总投入超出可用资金 | "方案A: 總投入 1,500,000 超過可用資金 1,000,000" | 标记为无效方案，不参与对比 |
| IPO 数据不完整 | "方案B: 未配置IPO或數據不完整" | 标记为无效方案 |
| 所有方案都无效 | 显示每个方案的具体问题 | 阻止计算 |

---

### 4.3 事后验证计算器（收益验证）

#### 4.3.1 功能目标
在配售结果公布后，帮助用户验证实际收益，并对比**如果选择其他档位**的假设收益，评估策略是否正确。

#### 4.3.2 核心场景

**典型使用流程**：
1. 用户打了赛力斯甲组 30,000 股，中签 375 股
2. 首日以 HKD 27.50 卖出
3. 输入数据到计算器，查看实际收益
4. 系统自动对比：如果打乙组 50,000 股，收益会是多少？
5. 得出结论：应该打乙组（或当前策略最优）

#### 4.3.3 输入参数

##### A. 基础配置

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| IPO代码 | String | ✅ | 支持手动输入+下拉建议 |
| 发行价 (HKD) | Number | ✅ | 选择IPO后自动填充 |
| 申购股数 | Number | ✅ | 实际申购的股数 |
| 中签股数 | Number | ✅ | 实际获得的股数 |
| 卖出价格 (HKD) | Number | ✅ | 实际卖出价格 |
| 卖出费用 (HKD) | Number | ✅ | 包含印花税、交易征费、佣金等所有费用 |

##### B. 融资配置

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| 使用融资 | Boolean | ✅ | false | 是否启用融资 |
| 融资金额 (HKD) | Number | - | 0 | 实际融资金额 |
| 融资年利率 (%) | Number | - | 5 | 年化利率 |
| 持有天数 | Number | - | 7 | 从申购到卖出 |

#### 4.3.4 计算逻辑

##### A. 实际收益计算

```javascript
// 1. 收入
const revenue = 中签股数 × 卖出价格

// 2. 成本
const 申购成本 = 中签股数 × 发行价
const 融资成本 = 融资金额 × (融资年利率 / 100) × (持有天数 / 365)
const 总费用 = 卖出费用 + 融资成本

// 3. 净收益
const 净收益 = revenue - 申购成本 - 总费用

// 4. 收益率（基于本金）
const 本金 = (申购股数 × 发行价) - 融资金额
const 收益率 = (净收益 / 本金) × 100

// 5. 打和点（不亏不赚的卖出价格）
const 打和点 = (申购成本 + 总费用) / 中签股数
```

##### B. 策略对比逻辑（核心创新功能）

**数据来源**：
- 从数据库的 `申购明细` 表和 `apply_tiers` 表联合查询，获取该股票的所有档位信息

**假设前提**：
- 每个档位假设 **10倍融资** 场景
- 本金 = 该档位申购总额 / 10
- 融资金额 = 该档位申购总额 × 0.9

**单个档位收益计算**：
```javascript
const calculateStrategy = (tierInfo, 卖出价格, 发行价) => {
  // 1. 该档位的申购数据
  const 申购股数 = tierInfo.shares_applied
  const 配发比例 = tierInfo.approx_alloc_pct
  const 有效申购人数 = tierInfo.valid_applications
  const 中签人数 = tierInfo.winners
  
  // 2. 计算中签股数（关键公式）
  const 中签股数 = Math.round((配发比例 × 有效申购人数 × 申购股数) / 中签人数)
  
  // 3. 收入
  const revenue = 中签股数 × 卖出价格
  const profit = revenue - (中签股数 × 发行价)
  
  // 4. 融资设定（10倍融资假设）
  const 申购总额 = 申购股数 × 发行价
  const 本金 = 申购总额 / 10
  const 融资金额 = 申购总额 × 0.9
  const 融资成本 = 融资金额 × (融资年利率 / 100) × (持有天数 / 365)
  
  // 5. 卖出费用（按比例估算）
  const 卖出费用估算 = revenue × 0.002  // 假设0.2%综合费率
  
  // 6. 净收益和收益率
  const 净收益 = profit - 融资成本 - 卖出费用估算
  const 收益率 = (净收益 / 本金) × 100
  
  // 7. 数学期望（考虑中签率）
  const 数学期望 = 净收益 × (配发比例 / 100)
  
  return {
    档位: tierInfo.apply_group,
    申购股数,
    中签股数,
    本金,
    融资金额,
    融资成本,
    收入: revenue,
    毛利: profit,
    净收益,
    收益率,
    数学期望,
    配发比例
  }
}
```

**自动识别实际档位**：
```javascript
// 根据用户输入的申购股数，匹配数据库中的档位
const actualTier = tiers.find(tier => 
  Math.abs(tier.shares_applied - 申购股数输入) < 0.01
)
```

#### 4.3.5 输出结果

##### A. 实际收益卡片

```
实际收益（已扣除所有费用）
HKD +9,375.00

收益率（基于本金）
+93.75%

打和点
HKD 20.13
```

##### B. 策略对比表格

| 档位 | 申购股数 | 中签股数 | 本金 (HKD) | 融资额 (HKD) | 融资成本 (HKD) | 净收益 (HKD) | 收益率 (%) | 数学期望 (HKD) |
|------|----------|----------|------------|--------------|----------------|--------------|------------|----------------|
| ✓ 甲组 | 30,000 | 375 | 75,000 | 675,000 | -630 | +9,375 | +12.50% | +9,375 |
| 乙组 ⭐ | 50,000 | 625 | 125,000 | 1,125,000 | -1,050 | +15,625 | +12.50% | +15,625 |

- **绿色高亮**: 实际选择的档位
- **⭐ 标记**: 最优档位

##### C. 分析结论

```
• 最優策略為 乙组（50,000股），淨收益 HKD 15,625，收益率 12.50%
• 實際選擇 甲组，淨收益 HKD 9,375，收益率 12.50%
• 如果選擇 乙组，可以多賺 HKD 6,250 (+66.67%)
• 建議：下次打新時，如有充足本金和融資額度，應選擇 乙组
```

**策略建议（10倍融资假设）**：
```
• 雖然實際選擇的 甲组 收益率與最優策略相同，但 乙组 的絕對收益更高
• 10倍融資假設下：
  - 甲组 需要本金 75,000，融資 675,000
  - 乙组 需要本金 125,000，融資 1,125,000
• 如果本金和融資額度允許，建議選擇 乙组 以最大化收益
```

##### D. 计算说明

```
計算說明（10倍融資假設）

• 中籤股數計算公式：
  中籤股數 = (配發比例 × 有效申購人數 × 申請股數) / 中籤人數

• 10倍融資假設：
  - 本金 = 申購總額 / 10
  - 融資金額 = 申購總額 × 0.9
  - 融資成本 = 融資金額 × (年利率 / 365) × 持有天數

• 收益率計算：
  收益率 = 淨收益 / 本金 × 100%
  （注意：收益率基於本金計算，而非申購總額）

• 數學期望：
  數學期望 = 淨收益 × 配發比例
  （用於評估考慮中籤概率後的期望收益）

• 打和點：
  打和點 = (申購成本 + 所有費用) / 中籤股數
  （賣出價格等於打和點時，收益為0）
```

#### 4.3.6 技术实现

**后端 API**：
```javascript
// GET /api/tier-details/:stockCode
// 返回股票信息和所有档位的配售数据

{
  "stock": {
    "代码": "2670",
    "公司名称": "赛力斯",
    "发行价": 25.00,
    // ...
  },
  "tiers": [
    {
      "id": 2670,
      "shares_applied": 30000,
      "max_payment_hkd": 750000,
      "apply_group": "甲组",
      "match_key": "2670_30000",
      "approx_alloc_pct": 100,
      "valid_applications": 1500,
      "winners": 1500
    },
    {
      "id": 2670,
      "shares_applied": 50000,
      "max_payment_hkd": 1250000,
      "apply_group": "乙组",
      "match_key": "2670_50000",
      "approx_alloc_pct": 100,
      "valid_applications": 1200,
      "winners": 1200
    }
    // ... 更多档位
  ]
}
```

---

### 4.4 档位详情页

#### 4.4.1 功能目标
展示某只股票的所有申购档位信息和配售结果，帮助用户研究不同档位的中签率和配发比例。

#### 4.4.2 页面结构

##### A. 股票基本信息卡片

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  赛力斯集团股份有限公司 (2670)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  发行价: HKD 25.00
  申购截止: 2025-10-15
  上市日期: 2025-10-22
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

##### B. 档位明细表格

| 申请股数 | 应缴费用 (HKD) | 组别 | 有效申购人数 | 中签人数 | 配发比例 (%) |
|----------|----------------|------|--------------|----------|--------------|
| 10,000 | 250,000 | 甲组 | 2,500 | 2,500 | 100.00% |
| 30,000 | 750,000 | 甲组 | 1,500 | 1,500 | 100.00% |
| 50,000 | 1,250,000 | 乙组 | 1,200 | 1,200 | 100.00% |
| 100,000 | 2,500,000 | 乙组 | 800 | 320 | 40.00% |

- 如果配售数据未更新，显示 "-"
- 点击"刷新"按钮可重新获取最新数据

##### C. 刷新按钮

```
┌──────────────┐
│   🔄 刷新    │  ← 点击后重新查询数据库
└──────────────┘
```

#### 4.4.3 数据来源

- **股票信息**: `招股书` 表
- **档位信息**: `申购明细` 表（实时更新）
- **配售数据**: `apply_tiers` 表（配售结果公布后更新）

**数据匹配逻辑**：
```javascript
// 1. 先通过 match_key 精确匹配
tierData = apply_tiers.find(t => t.match_key === detail.match_key)

// 2. 如果没找到，通过 id + shares_applied 模糊匹配
if (!tierData) {
  tierData = apply_tiers.find(t => 
    t.id === detail.id && 
    Math.abs(t.shares_applied - detail.shares_applied) < 0.01
  )
}

// 3. 如果还是没找到，显示 "-"
```

#### 4.4.4 响应式设计

- **桌面端**: 表格完整显示所有列
- **平板**: 缩小字体，调整列宽
- **移动端**: 
  - 隐藏部分次要列（如"应缴费用"）
  - 使用卡片式布局代替表格
  - 支持横向滑动查看完整数据

---

## 技术架构

### 5.1 技术栈

#### 前端
- **框架**: React 18
- **构建工具**: Vite 5.4
- **路由**: React Router DOM
- **HTTP 客户端**: Axios
- **样式**: CSS + Tailwind CSS（部分）
- **语言**: JavaScript (ES6+)

#### 后端
- **运行环境**: Node.js
- **框架**: Express.js
- **数据库**: PostgreSQL（云端托管在 Zeabur）
- **数据库客户端**: node-postgres (pg)
- **跨域**: CORS

#### 部署
- **开发环境**: 
  - 前端: `http://localhost:5173`
  - 后端: `http://localhost:3000`
- **生产环境**: 
  - 后端: Zeabur 云端部署
  - 数据库: Zeabur PostgreSQL

### 5.2 项目结构

```
打新计算器/
│
├── backend/
│   ├── server.js           # Express 服务器主文件
│   ├── package.json        # 后端依赖
│   └── node_modules/
│
├── frontend/
│   ├── src/
│   │   ├── main.jsx        # React 入口文件
│   │   ├── App.jsx         # 主应用组件（路由配置）
│   │   ├── App.css         # 全局样式
│   │   ├── index.css       # Tailwind 入口
│   │   └── components/
│   │       ├── Calculator.jsx      # 事前预测计算器
│   │       ├── PostCalculator.jsx  # 事后验证计算器
│   │       ├── StockTable.jsx      # 新股列表
│   │       └── StockDetail.jsx     # 档位详情页
│   ├── index.html          # HTML 模板
│   ├── vite.config.js      # Vite 配置（代理设置）
│   ├── tailwind.config.js  # Tailwind 配置
│   ├── package.json        # 前端依赖
│   └── node_modules/
│
├── .gitignore              # Git 忽略文件
├── README.md               # 项目说明
├── 启动指南.md             # 本地启动指南
└── PRD.md                  # 本文档
```

### 5.3 API 设计

#### A. 获取所有新股数据
```
GET /api/stocks

Response:
[
  {
    "代码": "2670",
    "公司名称": "赛力斯集团股份有限公司",
    "招股定价上限": 25.00,
    "发行价": 25.00,
    "申购截止日期": "2025-10-15",
    "上市日期": "2025-10-22",
    // ... 更多字段
  }
]
```

#### B. 获取股票档位详情
```
GET /api/stock-details/:stockCode

Response:
{
  "stockInfo": { /* 招股书数据 */ },
  "applyDetails": [ /* 申购明细数据 */ ],
  "applyTiers": [ /* 配售结果数据 */ ]
}
```

#### C. 获取档位配售详情（用于策略对比）
```
GET /api/tier-details/:stockCode

Response:
{
  "stock": { /* 招股书数据 */ },
  "tiers": [
    {
      "id": 2670,
      "shares_applied": 30000,
      "max_payment_hkd": 750000,
      "apply_group": "甲组",
      "match_key": "2670_30000",
      "approx_alloc_pct": 100,
      "valid_applications": 1500,
      "winners": 1500
    }
  ]
}
```

#### D. 健康检查
```
GET /api/health

Response:
{
  "status": "ok",
  "timestamp": "2025-11-02T02:04:53.995Z"
}
```

### 5.4 数据库设计（仅展示已使用的表）

#### 表 1: 招股书
```sql
CREATE TABLE 招股书 (
  代码 VARCHAR(10) PRIMARY KEY,
  公司名称 TEXT,
  招股定价上限 DECIMAL(10,2),
  发行价 DECIMAL(10,2),
  申购截止日期 DATE,
  上市日期 DATE,
  -- ... 其他字段
);
```

#### 表 2: 申购明细
```sql
CREATE TABLE 申购明细 (
  id INTEGER,
  shares_applied DECIMAL(15,2),
  max_payment_hkd DECIMAL(15,2),
  apply_group VARCHAR(50),
  match_key VARCHAR(100),
  PRIMARY KEY (id, shares_applied)
);
```

#### 表 3: apply_tiers（配售结果）
```sql
CREATE TABLE apply_tiers (
  id INTEGER,
  shares_applied DECIMAL(15,2),
  match_key VARCHAR(100),
  approx_alloc_pct DECIMAL(10,4),  -- 配发比例
  valid_applications INTEGER,       -- 有效申购人数
  winners INTEGER,                  -- 中签人数
  PRIMARY KEY (id, shares_applied)
);
```

**关联关系**：
```
招股书.代码 (id) 
  ↓
申购明细.id + 申购明细.match_key
  ↓
apply_tiers.id + apply_tiers.match_key
```

---

## 用户流程

### 6.1 事前预测流程

```mermaid
graph TD
    A[打开应用] --> B[点击"收益計算"导航]
    B --> C[输入本金]
    C --> D{使用融资?}
    D -->|是| E[选择融资倍数、利率、天数]
    D -->|否| F[继续]
    E --> F
    F --> G[点击"+ 添加IPO到此方案"]
    G --> H[选择IPO代码]
    H --> I[系统自动填充发行价和公司名称]
    I --> J[填写申购股数、预估中签率、预估中签股数、预期涨幅]
    J --> K{需要对比其他方案?}
    K -->|是| L[点击"+ 新增方案"]
    L --> M[切换到新方案]
    M --> G
    K -->|否| N[点击"計算 & 對比"]
    N --> O[查看方案对比表格]
    O --> P[查看最优方案标记⭐]
    P --> Q[阅读分析结论]
    Q --> R{调整方案?}
    R -->|是| S[修改IPO配置或方案]
    S --> N
    R -->|否| T[根据结果执行打新]
```

### 6.2 事后验证流程

```mermaid
graph TD
    A[配售结果公布] --> B[点击"收益驗證"导航]
    B --> C[输入或选择IPO代码]
    C --> D[系统自动填充发行价]
    D --> E[输入申购股数、中签股数、卖出价格、卖出费用]
    E --> F{使用融资?}
    F -->|是| G[输入融资金额、利率、天数]
    F -->|否| H[继续]
    G --> H
    H --> I[点击"計算"]
    I --> J[查看实际收益和收益率]
    J --> K{启用策略对比?}
    K -->|否| L[结束]
    K -->|是| M[系统自动获取所有档位数据]
    M --> N[计算所有档位的假设收益]
    N --> O[查看策略对比表格]
    O --> P[查看实际档位✓和最优档位⭐]
    P --> Q[阅读分析结论和建议]
    Q --> R[记录经验，优化下次策略]
```

### 6.3 档位研究流程

```mermaid
graph TD
    A[首页新股列表] --> B[点击某股票的"查看详情"按钮]
    B --> C[跳转到档位详情页]
    C --> D[查看股票基本信息]
    D --> E[浏览申购明细表]
    E --> F{配售数据已更新?}
    F -->|否| G[显示"-"]
    F -->|是| H[显示有效申购人数、中签人数、配发比例]
    G --> I[等待数据更新]
    I --> J[点击"刷新"按钮]
    J --> C
    H --> K[对比不同档位的配发比例]
    K --> L[选择合适的档位进行申购]
```

---

## UI/UX 设计原则

### 7.1 视觉风格

#### 设计理念
- **简约 (Minimalist)**: 去除所有不必要的装饰，聚焦核心功能
- **优雅 (Elegant)**: 精致的间距、细腻的边框、柔和的颜色
- **专业 (Professional)**: 符合金融产品的严肃感和可信度
- **现代 (Modern)**: 采用流行的 Glassmorphism（毛玻璃）效果

#### 配色方案

| 用途 | 颜色 | Hex/RGBA | 说明 |
|------|------|----------|------|
| 主背景 | 浅灰白 | `#f8f9fa` | 低对比度，减少视觉疲劳 |
| 卡片背景 | 白色 | `#ffffff` | 纯净、干净 |
| 主文本 | 深灰 | `#4a4a4a` | 比纯黑更柔和 |
| 次要文本 | 灰色 | `#999` | 用于辅助信息 |
| 标题文本 | 中灰 | `#666` | 用于小标题 |
| 成功/盈利 | 绿色 | `#22c55e` | 正向反馈 |
| 警告/亏损 | 红色 | `#c44` | 负向反馈 |
| 边框 | 浅灰 | `rgba(0,0,0,0.08)` | 极细的分割线 |
| 导航栏背景 | 半透明白 | `rgba(255,255,255,0.65)` + `backdrop-filter: blur(12px)` | Glassmorphism |

#### 字体系统

| 用途 | 字号 | 字重 | 说明 |
|------|------|------|------|
| 大标题 | 1.2rem | 400 | 页面主标题 |
| 小标题 | 0.7rem | 400 | 章节标题（全大写） |
| 正文 | 0.75rem | 300 | 主要内容 |
| 表格文字 | 0.72rem | 300 | 数据展示 |
| 表头 | 0.68rem | 400 | 表格标题（全大写） |
| 备注 | 0.65rem | 300 | 计算说明等 |

**字重规则**：
- 300: 正文、数据（主要内容）
- 400: 标题（层级标记）
- 500: 高亮、强调

### 7.2 交互设计

#### 按钮样式

**主要按钮** (Primary):
```css
background: #4a4a4a;
color: white;
padding: 0.8rem 1.5rem;
border-radius: 6px;
transition: all 0.2s;
```

**次要按钮** (Secondary):
```css
background: transparent;
border: 1px solid rgba(0,0,0,0.1);
color: #666;
padding: 0.8rem 1.5rem;
border-radius: 6px;
```

**虚线按钮** (添加类):
```css
background: transparent;
border: 1px dashed rgba(0,0,0,0.2);
color: #666;
padding: 0.8rem;
border-radius: 6px;
```

#### 表单输入

```css
input, select {
  padding: 0.8rem;
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: 6px;
  font-size: 0.75rem;
  transition: border-color 0.2s;
}

input:focus, select:focus {
  border-color: #4a4a4a;
  outline: none;
}
```

#### 表格样式

- **行高亮**: 鼠标悬停时，行背景变为 `rgba(100,100,100,0.02)`
- **斑马纹**: 不使用（保持简洁）
- **边框**: 仅使用底部边框 `border-bottom: 1px solid rgba(100,100,100,0.08)`
- **对齐**: 数字右对齐，文字左对齐，表头居中

#### 加载状态

```
┌──────────────────────┐
│   ⏳ 計算中...       │
└──────────────────────┘
```

#### 空状态

```
┌──────────────────────┐
│   📝 暫無數據        │
│   請先添加IPO配置    │
└──────────────────────┘
```

### 7.3 响应式设计

#### 断点 (Breakpoints)

| 设备 | 宽度 | 调整内容 |
|------|------|----------|
| 桌面 | ≥ 1200px | 完整布局，表格完全展开 |
| 平板 | 768px - 1199px | 缩小字体，调整列宽 |
| 移动 | < 768px | 单列布局，表格横向滚动或卡片式 |

#### 移动端优化

1. **导航栏**：
   - 固定顶部
   - 增加点击区域大小
   - 使用汉堡菜单（如空间不足）

2. **输入表单**：
   - 全宽布局
   - 增大输入框高度（方便点击）
   - 使用原生移动键盘（`type="number"` 等）

3. **表格**：
   - 允许横向滑动
   - 使用粘性表头（`position: sticky`）
   - 或改为卡片式布局

4. **按钮**：
   - 全宽或大尺寸
   - 增加间距，防止误触

---

## 版本规划

### v1.0（已完成）✅

**发布日期**: 2025-11-02

**功能清单**:
- ✅ 新股列表与查询
- ✅ 档位详情页
- ✅ 事前预测计算器（多方案对比）
- ✅ 事后验证计算器（策略对比）
- ✅ 融资倍数选择和融资成本计算
- ✅ 响应式设计
- ✅ 数据库集成（PostgreSQL）
- ✅ 错误提示优化

### v1.1（计划中）🔜

**预计发布**: 2025-11 下旬

**新增功能**:
- 📊 **历史数据分析**：
  - 查看过去6个月的 IPO 涨跌统计
  - 平均中签率、平均涨幅
  - 按行业、市值分类分析

- 💾 **方案保存**：
  - 本地存储（LocalStorage）方案配置
  - 快速加载历史方案
  - 方案命名和备注

- 🔔 **智能提醒**：
  - 申购截止日期提醒
  - 上市日期提醒
  - 配售结果公布提醒

### v1.2（计划中）

**预计发布**: 2025-12

**新增功能**:
- 🤖 **AI 推荐**：
  - 基于历史数据的中签率预测
  - 涨幅预测（机器学习模型）
  - 自动生成最优方案

- 📈 **高级图表**：
  - 收益趋势图（折线图）
  - 档位分布图（柱状图）
  - 风险-收益散点图

- 🔍 **高级筛选**：
  - 按发行价、市值、行业筛选
  - 按申购截止日期排序
  - 收藏和标记功能

### v2.0（远期规划）

**新增功能**:
- 👥 **多用户支持**：
  - 用户注册和登录
  - 个人投资组合追踪
  - 收益历史记录

- 🌐 **社区功能**：
  - 分享方案配置
  - 用户评论和讨论
  - 策略排行榜

- 📱 **移动应用**：
  - iOS / Android 原生应用
  - 推送通知
  - 离线模式

- 🔗 **券商集成**：
  - 对接券商 API
  - 自动获取实际申购数据
  - 一键申购

---

## 附录

### 附录 A: 术语表

| 术语 | 英文 | 解释 |
|------|------|------|
| 打新 | IPO Subscription | 申购新股（首次公开募股） |
| 中签 | Allocation | 申购成功，获得股票配额 |
| 中签率 | Allocation Rate | 申购人数中，实际获得股票的比例 |
| 配发比例 | Allotment Ratio | 获得的股数占申购股数的比例 |
| 档位 | Tier | 不同申购股数对应的分组，通常分甲组、乙组 |
| 融资 | Margin Financing | 通过券商借钱增加申购资金 |
| 融资倍数 | Leverage | 本金可以放大的倍数（如10倍融资 = 10万变100万） |
| 打和点 | Break-even Point | 不亏不赚的卖出价格 |
| 期望收益 | Expected Return | 考虑概率后的平均收益 |
| 数学期望 | Mathematical Expectation | 净收益 × 中签率 |

### 附录 B: 计算公式汇总

#### 事前预测

```
总可用资金 = 本金 × 融资倍数

单个IPO投入 = 申购股数 × 发行价

单个IPO期望收益 = 预估中签股数 × 发行价 × (预期涨幅 / 100) × (预估中签率 / 100)

方案总投入 = Σ(每个IPO的投入)

方案总期望收益 = Σ(每个IPO的期望收益)

融资金额 = min(总投入 - 本金, 总投入 × 0.9)

融资成本 = 融资金额 × (融资年利率 / 100) × (持有天数 / 365)

净收益 = 总期望收益 - 融资成本

收益率 = (净收益 / 本金) × 100%
```

#### 事后验证

```
收入 = 中签股数 × 卖出价格

成本 = 中签股数 × 发行价

毛利 = 收入 - 成本

融资成本 = 融资金额 × (融资年利率 / 100) × (持有天数 / 365)

净收益 = 毛利 - 融资成本 - 卖出费用

本金 = (申购股数 × 发行价) - 融资金额

收益率 = (净收益 / 本金) × 100%

打和点 = (成本 + 融资成本 + 卖出费用) / 中签股数
```

#### 策略对比（10倍融资假设）

```
档位中签股数 = (配发比例 × 有效申购人数 × 申购股数) / 中签人数

档位申购总额 = 申购股数 × 发行价

档位本金 = 申购总额 / 10

档位融资金额 = 申购总额 × 0.9

档位融资成本 = 融资金额 × (融资年利率 / 100) × (持有天数 / 365)

档位收入 = 中签股数 × 卖出价格

档位毛利 = 收入 - (中签股数 × 发行价)

档位卖出费用估算 = 收入 × 0.002

档位净收益 = 毛利 - 融资成本 - 卖出费用估算

档位收益率 = (净收益 / 本金) × 100%

档位数学期望 = 净收益 × (配发比例 / 100)
```

### 附录 C: 数据流图

```
数据库（PostgreSQL）
    │
    ├── 招股书表
    │     │
    │     ├──> [GET /api/stocks] ──> 新股列表页
    │     │
    │     └──> [GET /api/stock-details/:code] ──> 档位详情页
    │
    ├── 申购明细表
    │     │
    │     └──> [GET /api/stock-details/:code] ──> 档位详情页
    │
    └── apply_tiers表
          │
          ├──> [GET /api/stock-details/:code] ──> 档位详情页
          │
          └──> [GET /api/tier-details/:code] ──> 事后验证计算器（策略对比）
```

### 附录 D: 常见问题 (FAQ)

#### Q1: 为什么事前预测的"预估中签率"和"预估中签股数"需要手动输入？
**A**: 因为在申购前，配售结果还未公布，系统无法自动获取准确的中签率和中签股数。用户需要基于历史数据或经验进行预估。

#### Q2: 事后验证的"策略对比"中，为什么假设10倍融资？
**A**: 10倍融资是香港券商常见的融资倍数，用于标准化对比不同档位。这样可以公平地比较：如果每个档位都使用10倍融资，哪个档位的收益率最高。

#### Q3: "数学期望"是什么意思？
**A**: 数学期望 = 净收益 × 中签率，表示考虑中签概率后的平均收益。例如：某档位净收益10,000元，但中签率只有20%，则数学期望 = 10,000 × 20% = 2,000元。

#### Q4: 为什么有时候档位详情页显示"-"？
**A**: 因为配售结果还未公布，数据库中的 `apply_tiers` 表还没有该股票的数据。可以等结果公布后点击"刷新"按钮更新。

#### Q5: 融资成本是怎么计算的？
**A**: 融资成本 = 融资金额 × (年利率 / 365) × 持有天数。例如：融资90万，年利率5%，持有7天，融资成本 = 900,000 × 0.05 / 365 × 7 = 863元。

#### Q6: 为什么收益率基于"本金"而不是"总投入"？
**A**: 因为对于投资者来说，真正的成本是自己的本金，融资部分是借来的。收益率基于本金计算更能反映实际投资回报。

---

## 文档维护

**文档作者**: AI Assistant (Claude Sonnet 4.5)  
**审核人**: Daiyu Xin  
**版本历史**:
- v1.0 (2025-11-02): 初始版本，完整覆盖所有已实现功能

**反馈渠道**:
- GitHub Issues: https://github.com/DaiyuxinFS/ipo_calculator/issues
- Email: [待补充]

---

**🎉 感谢使用香港 IPO 打新计算器！**

如有任何问题或建议，欢迎通过 GitHub 提交 Issue 或 Pull Request。

